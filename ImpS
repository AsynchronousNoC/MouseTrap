#method to get positions from cells
proc getAbsRLOC {cell} {
	set site [get_sites -of [get_cells $cell]] 
	set X [get_property RPM_X $site]
	set Y [get_property RPM_Y $site] 
	return "X${X}Y${Y}"
	}
	
#procedura per l'ottimizzazione
proc MaxTimeConstrain {Stage1 fileDescriptor} {
	puts $fileDescriptor [subst "\n\n#Puts closure time max_delay"]
	#usando i doppi apici non mi funziona l'escape del carattere
	#se non si dichiarano gli endpoint con get_pins ma con get_cells prende quelli sbagliati e questo porta a path segmentation-> alcuni vincoli vengono eliminati
	puts $fileDescriptor [subst {set_max_delay -from \[get_pins $Stage1/req_latch/G\] -to \[get_pins $Stage1/*.Data_latch/GE\] 0.000}]
	puts $fileDescriptor [subst {set_max_delay -from \[get_pins $Stage1/req_latch/G\] -to \[get_pins $Stage1/req_latch/GE\] 0.000}]
	puts $fileDescriptor "\n\n"
}
	
set WIDTH 32
set Mousetrap_name "mousetrap_ldce_woMacros"


#prepareCodeToRunWithout RLOC
set f [open ./Sources/Design/TopModule.sv r]
set file_data [read $f]
close $f
set f [open Temp.sv w+] 
set data [split $file_data "\n"]
foreach line $data {
	if { [regexp -all "mousetrap_ldce" $line] } { 
		regsub -all "mousetrap_ldce" $line "mousetrap_ldce_woMacros" line
	} elseif { [regexp -all "parameter WORD_WIDTH" $line] } {
		set line [subst "parameter WORD_WIDTH=$WIDTH"]
	}
		puts $f $line
}
close $f
exec mv Temp.sv ./Sources/Design/TopModule.sv



#run implementation with pblock
set_property is_enabled true [get_files  DefineImplBoundaries.xdc]
reset_run synth_1
launch_runs synth_1 -jobs 6
wait_on_run synth_1
	
open_run synth_1 -name synth_1	
set Pipelines [get_cells -hierarchical -filter [subst {ORIG_REF_NAME== $Mousetrap_name || REF_NAME== $Mousetrap_name}]]
set f [open Temp.xdc w+] 
foreach cell $Pipelines {
	MaxTimeConstrain $cell $f
}
#chiudo il file e lo muovo nel constraint che uso
close $f
exec mv Temp.xdc ./Sources/Constraints/DefineImplConstraints.xdc
	
set_property is_enabled true [get_files  DefineImplConstraints.xdc]
launch_runs impl_1 -jobs 6
wait_on_run impl_1
set_property is_enabled false [get_files  DefineImplConstraints.xdc]
set_property is_enabled false [get_files  DefineImplBoundaries.xdc]

#prepareCodeToRunWithout RLOC
set f [open ./Sources/Design/TopModule.sv r]
set file_data [read $f]
close $f
set f [open Temp.sv w+] 
set data [split $file_data "\n"]
foreach line $data {
	if { [regexp -all "mousetrap_ldce_woMacros" $line] } { 
		regsub -all "mousetrap_ldce_woMacros" $line "mousetrap_ldce" line
	} elseif { [regexp -all "parameter WORD_WIDTH" $line] } {
		set line [subst "parameter WORD_WIDTH=$WIDTH"]
	}
		puts $f $line
}
close $f
exec mv Temp.sv ./Sources/Design/TopModule.sv

#get implementation positions
#dataLatch positions
open_run impl_1
set Datalatch  [subst "  WIDTH=='d$WIDTH ?  {\""];append Datalatch [getAbsRLOC [lindex [get_cells *.Stadio_2/*.Data_latch] 0]]; append Datalatch "\""
for {set x 1} {$x<$WIDTH} {incr x} {append Datalatch ",\"";append Datalatch [getAbsRLOC [lindex [get_cells *.Stadio_2/*.Data_latch] $x]];append Datalatch  "\""}
append Datalatch "} :";append Datalatch  [subst "//$WIDTH Bit DataCellAddress"]

#dataLatchBELS
set DataBELS [subst "  WIDTH=='d$WIDTH ?  {\""];append DataBELS [lindex [split [get_property BEL [lindex [get_cells *.Stadio_2/*.Data_latch] 0]] "."] 1]; append DataBELS "\""
for {set x 1} {$x<$WIDTH} {incr x} {append DataBELS ",\"";append DataBELS  [lindex [split [get_property BEL [lindex [get_cells *.Stadio_2/*.Data_latch] $x]] "."] 1];append DataBELS  "\""}
append DataBELS "} :";append DataBELS  [subst "//$WIDTH Bit DataCellBELL"]

#reqLath positions
set ReqLatch [subst "  WIDTH=='d$WIDTH ?\""];append ReqLatch [getAbsRLOC [lindex [get_cells *.Stadio_2/req_latch] 0]]; append ReqLatch "\" :";append ReqLatch  [subst "//$WIDTH Bit ReqCellAddress"]

set ReqBELL [subst "  WIDTH=='d$WIDTH ?\""];append ReqBELL [lindex [split [get_property BEL [lindex [get_cells *.Stadio_2/req_latch] 0]] "."] 1]; append ReqBELL "\" :";append ReqBELL  [subst "//$WIDTH Bit ReqCellBELL"]

#LUT position
set ReqLut  [subst "  WIDTH=='d$WIDTH ?\""];append ReqLut [getAbsRLOC [lindex [get_cells *.Stadio_2/ReqXor] 0]]; append ReqLut "\" :";append ReqLut  [subst "//$WIDTH Bit ReqXorAddress"]

#write new positions to file
set f [open ./Sources/Design/Mousetrap.sv r]
set file_data [read $f]
close $f
set f [open Temp.sv w+] 
set data [split $file_data "\n"]
foreach line $data {
	if { [regexp -all [subst "$WIDTH Bit DataCellAddress"] $line] } { 
		puts $f $Datalatch
	} elseif { [regexp -all [subst "$WIDTH Bit DataCellBELL"] $line] } {
		puts $f $DataBELS
	} elseif { [regexp -all [subst "$WIDTH Bit ReqCellAddress"] $line] } {
		puts $f $ReqLatch
	} elseif { [regexp -all [subst "$WIDTH Bit ReqCellBELL"] $line] } {
		puts $f $ReqBELL
	} elseif { [regexp -all [subst "$WIDTH Bit ReqXorAddress"] $line] } {
		puts $f $ReqLut
	} else {
		puts $f $line
	}
}
close $f
exec mv Temp.sv ./Sources/Design/Mousetrap.sv




#lunch new implementation with new positions
#reset_run synth_1
#launch_runs impl_1 -jobs 6
#wait_on_run impl_1

