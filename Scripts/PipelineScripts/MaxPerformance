#procedura per l'ottimizzazione
proc MaxTimeConstrain {Stage1 Stage2 fileDescriptor} {
	puts $fileDescriptor [subst "\n\n#Puts max_delay constrain from $Stage1 to $Stage2"]
	#usando i doppi apici non mi funziona l'escape del carattere
	#se non si dichiarano gli endpoint con get_pins ma con get_cells prende quelli sbagliati e questo porta a path segmentation-> alcuni vincoli vengono eliminati
	puts $fileDescriptor [subst {set_max_delay -from \[get_pins $Stage1/*.Data_latch/Q\] -to \[get_pins $Stage2/*.Data_latch/D\] 0.000}]
	puts $fileDescriptor [subst {set_max_delay -from \[get_pins $Stage1/req_latch/Q\] -to \[get_pins $Stage2/req_latch/D\] 0.000}]
	puts $fileDescriptor [subst {set_max_delay -from \[get_pins $Stage1/req_latch/Q\] -to \[get_pins $Stage1/*.Data_latch/GE\] 0.000}]
	puts $fileDescriptor [subst {set_max_delay -from \[get_pins $Stage1/req_latch/Q\] -to \[get_pins $Stage1/req_latch/GE\] 0.000}]
	puts $fileDescriptor [subst {set_max_delay -from \[get_pins $Stage2/req_latch/Q\] -to \[get_pins $Stage1/req_latch/GE\] 0.000}]
	puts $fileDescriptor "\n\n"
}

#---------------MAIN----------------#
#Global variables
	set Mousetrap_name "mousetrap_ldce"

#---------Ottimizzazione
	open_run synth_1 -name synth_1
	#---------Preparazione Constraint File
	set Pipelines [get_cells -hierarchical -filter [subst {ORIG_REF_NAME== $Mousetrap_name || REF_NAME== $Mousetrap_name}]]
	set f [open Temp.xdc w+] 
	foreach cell $Pipelines {
		foreach cellInter $Pipelines {
			set Coppia [get_timing_paths -from [get_cells $cell/*.Data_latch] -to [get_cells $cellInter/*.Data_latch] -quiet]
			if {$Coppia != ""} {
				MaxTimeConstrain $cell $cellInter $f
			}
		}
	}
	close $f
	exec mv Temp.xdc ./Sources/Constraints/BundledConstraints.xdc
