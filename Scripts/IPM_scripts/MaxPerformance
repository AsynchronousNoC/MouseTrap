#procedura per l'ottimizzazione
proc MaxTimeConstrain {Switch Iport fileDescriptor} {
	set Startpoint "Q"
	puts $fileDescriptor [subst "\n\n#Puts max_delay constrain in $Iport"]
	#usando i doppi apici non mi funziona l'escape del carattere
	#se non si dichiarano gli endpoint con get_pins ma con get_cells prende quelli sbagliati e questo porta a path segmentation-> alcuni vincoli vengono eliminati
	#ClosureTimings
	puts $fileDescriptor [subst {set_max_delay -from \[get_pins $Iport/input_pipe/req_latch/$Startpoint\] -to \[get_pins $Iport/input_pipe/*.Data_latch/GE\] 0.000}]
	puts $fileDescriptor [subst {set_max_delay -from \[get_pins $Iport/input_pipe/req_latch/$Startpoint\] -to \[get_pins $Iport/input_pipe/req_latch/GE\] 0.000}]
	#Data->amd
	puts $fileDescriptor [subst {set_max_delay -from \[get_pins $Iport/input_pipe/*.Data_latch/$Startpoint\] -to \[get_pins $Iport/PRC/*.RouteAnd/I1\] 0.000}]
	#req->and
	puts $fileDescriptor [subst {set_max_delay -from \[get_pins $Iport/input_pipe/req_latch/$Startpoint\] -to \[get_pins $Iport/PRC/*.RouteAnd/I0\] 0.000}]
	#req->#req
	puts $fileDescriptor [subst {set_max_delay -from \[get_pins $Iport/input_pipe/req_latch/$Startpoint\] -to \[get_pins $Switch/*.OPMS/req_input/D\] 0.000}]
	#data->#data
	puts $fileDescriptor [subst {set_max_delay -from \[get_pins $Iport/input_pipe/*.Data_latch/$Startpoint\] -to \[get_pins $Switch/*.OPMS/*.data_input/D\] 0.000}]
	puts $fileDescriptor "\n\n"
}

#---------------MAIN----------------#
#Global variables
	set InportPortModule "ipm"
	set Switch "Switch"

#---------Ottimizzazione
	open_run synth_1 -name synth_1
	set f [open Temp.xdc w+] 
	#---------Preparazione Constraint File
	set Switches [get_cells -hierarchical -filter [subst {ORIG_REF_NAME== $Switch || REF_NAME== $Switch}]]
	foreach Switch $Switches {
		set InportModules [get_cells -filter [subst {ORIG_REF_NAME== $InportPortModule || REF_NAME== $InportPortModule}] $Switches/*]
		foreach Iport $InportModules {
			MaxTimeConstrain $Switch $Iport $f
		}
	}
	close $f
	exec mv Temp.xdc ./Sources/Constraints/BundledConstraints.xdc
